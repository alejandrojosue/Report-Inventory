<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Ventas - Pollolandia</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }

        th,
        td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>
</head>

<body>
    <div hidden>
        <h1>Reporte de Ventas - Pollolandia</h1>
        <h2>Nombre de la Empresa</h2>

        <table>
            <thead>
                <tr>
                    <th>nombreProducto</th>
                    <th>Inicio</th>
                    <th>adicion</th>
                    <th>total</th>
                    <th>existenciaCierre</th>
                    <th>TotalVenta</th>
                    <th>Lps</th>
                </tr>
            </thead>
            <tbody id="report-data">
                <!-- Aquí se agregará el contenido de las ventas -->
            </tbody>
        </table>

    </div>
    <script type="module">
        import ProductsController from './controllers/ProductsController.js';
        import SalesController from './controllers/SalesController.js';

        class ReportGenerator {
            constructor() {
                this.productsController = new ProductsController();
                this.salesController = new SalesController();
            }

            async generateReport() {
                try {
                    // Obtener todos los productos
                    const products = await this.productsController.getAll();

                    // Obtener todas las ventas realizadas hoy
                    const currentDate = new Date().toLocaleDateString();
                    const sales = await this.salesController.getAll();
                    const salesToday = sales.filter(sale => sale.created_at.split('|')[0] == currentDate);

                    // Inicializar un objeto para el informe
                    const report = [];

                    // Calcular la cantidad de cada producto vendido hoy
                    for (const product of products) {
                        const productSoldToday = salesToday.reduce((total, sale) => {
                            const soldProduct = sale.products.find(p => p.id === product.id);
                            return total + (soldProduct ? soldProduct.quantity : 0);
                        }, 0);

                        const productAmountSoldToday = salesToday.reduce((total, sale) => {
                            const soldProduct = sale.products.find(p => p.id === product.id);
                            return total + (soldProduct ? soldProduct.amount : 0);
                        }, 0);

                        const productAvailable = product.stock - productSoldToday;

                        report.push({
                            Producto: product.name,
                            "Vendidos Hoy": productSoldToday,
                            "Valor Total": productAmountSoldToday,
                            "Disponibles": productAvailable
                        });
                    }

                    console.table(report); // Esto imprime el informe en la consola en forma de tabla

                    // También puedes devolver el informe como un objeto JSON
                    // return report;

                    return "Informe generado exitosamente.";
                } catch (error) {
                    return `Error al generar el informe: ${error}`;
                }
            }
        }

        // Ejemplo de uso
        const reportGenerator = new ReportGenerator();
        reportGenerator.generateReport().then(console.log).catch(console.error);


    </script>
    <!-- <script>
        const ventas = [
            {
                nombreProducto: "Pollo Entero",
                Inicio: 10,
                adicion: 5,
                total: 15,
                existenciaCierre: 3,
                TotalVenta: 12,
                Lps: 240
            },
            {
                nombreProducto: "Papas Fritas",
                Inicio: 30,
                adicion: 10,
                total: 40,
                existenciaCierre: 15,
                TotalVenta: 25,
                Lps: 100
            },
            {
                nombreProducto: "Ala de Pollo",
                Inicio: 20,
                adicion: 8,
                total: 28,
                existenciaCierre: 12,
                TotalVenta: 16,
                Lps: 320
            },
            {
                nombreProducto: "Ensalada César",
                Inicio: 15,
                adicion: 5,
                total: 20,
                existenciaCierre: 8,
                TotalVenta: 12,
                Lps: 180
            },
            {
                nombreProducto: "Taco de Pollo",
                Inicio: 25,
                adicion: 12,
                total: 37,
                existenciaCierre: 18,
                TotalVenta: 19,
                Lps: 380
            },
            {
                nombreProducto: "Muslo de Pollo",
                Inicio: 18,
                adicion: 7,
                total: 25,
                existenciaCierre: 10,
                TotalVenta: 15,
                Lps: 300
            },
            {
                nombreProducto: "Bebida Gaseosa",
                Inicio: 50,
                adicion: 20,
                total: 70,
                existenciaCierre: 30,
                TotalVenta: 40,
                Lps: 400
            },
            {
                nombreProducto: "Ensalada Mixta",
                Inicio: 12,
                adicion: 6,
                total: 18,
                existenciaCierre: 5,
                TotalVenta: 13,
                Lps: 195
            },
            {
                nombreProducto: "Pechuga de Pollo",
                Inicio: 22,
                adicion: 9,
                total: 31,
                existenciaCierre: 14,
                TotalVenta: 17,
                Lps: 340
            },
            {
                nombreProducto: "Taco de Res",
                Inicio: 28,
                adicion: 15,
                total: 43,
                existenciaCierre: 20,
                TotalVenta: 23,
                Lps: 460
            },
            {
                nombreProducto: "Taco de Pescado",
                Inicio: 15,
                adicion: 8,
                total: 23,
                existenciaCierre: 10,
                TotalVenta: 13,
                Lps: 260
            },
            {
                nombreProducto: "Refresco de Frutas",
                Inicio: 40,
                adicion: 18,
                total: 58,
                existenciaCierre: 25,
                TotalVenta: 33,
                Lps: 330
            },
            {
                nombreProducto: "Combo Familiar",
                Inicio: 5,
                adicion: 2,
                total: 7,
                existenciaCierre: 3,
                TotalVenta: 4,
                Lps: 120
            },
        ];

        const reportData = document.getElementById("report-data");

        ventas.forEach(venta => {
            const row = document.createElement("tr");
            row.innerHTML = `
        <td>${venta.nombreProducto}</td>
        <td>${venta.Inicio}</td>
        <td>${venta.adicion}</td>
        <td>${venta.total}</td>
        <td>${venta.existenciaCierre}</td>
        <td>${venta.TotalVenta}</td>
        <td>${venta.Lps}</td>
      `;
            reportData.appendChild(row);
        });


        window.onload = () => {
            const printWindow = window.open("", "_self");
            printWindow.document.write(`
                <html>
                <head>
                <title>Reporte de Ventas - Pollolandia</title>
                <style>
                    ${document.querySelector("style").innerHTML}
                </style>
                </head>
                <body>
                <h1>Reporte de Ventas - Pollolandia</h1>
                <h2>Nombre de la Empresa</h2>
                <table>
                    <thead>
                    <tr>
                        <th>nombreProducto</th>
                        <th>Inicio</th>
                        <th>adicion</th>
                        <th>total</th>
                        <th>existenciaCierre</th>
                        <th>TotalVenta</th>
                        <th>Lps</th>
                    </tr>
                    </thead>
                    <tbody>
                    ${reportData.innerHTML}
                    </tbody>
                </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            window.onbeforeprint = (event) => console.log("before print")
            window.onafterprint = (event) => location.href = './index.html'
        }
    </script> -->
</body>

</html>